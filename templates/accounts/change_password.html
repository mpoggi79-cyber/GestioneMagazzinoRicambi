{% extends 'base.html' %}
{% load static %}

{% block title %}Cambio Password - Magazzino Ricambi{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-key"></i> Cambia Password
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Requisiti password:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Almeno 10 caratteri</li>
                            <li>Almeno una lettera maiuscola</li>
                            <li>Almeno una lettera minuscola</li>
                            <li>Almeno un numero</li>
                            <li>Almeno un carattere speciale (@, #, $, %, etc.)</li>
                        </ul>
                    </div>
                    
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="id_old_password" class="form-label">
                                <i class="fas fa-lock"></i> Password Attuale *
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       name="old_password" 
                                       id="id_old_password"
                                       class="form-control"
                                       placeholder="Inserisci la tua password attuale"
                                       required>
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePasswordVisibility('id_old_password', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                Inserisci la password che usi attualmente per accedere
                            </small>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="mb-3">
                            <label for="id_new_password1" class="form-label">
                                <i class="fas fa-lock-open"></i> Nuova Password *
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       name="new_password1" 
                                       id="id_new_password1"
                                       class="form-control"
                                       placeholder="Inserisci la nuova password"
                                       required
                                       minlength="10">
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePasswordVisibility('id_new_password1', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="passwordStrength" class="mt-2"></div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="id_new_password2" class="form-label">
                                <i class="fas fa-check-double"></i> Conferma Nuova Password *
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       name="new_password2" 
                                       id="id_new_password2"
                                       class="form-control"
                                       placeholder="Ripeti la nuova password"
                                       required
                                       minlength="10">
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="togglePasswordVisibility('id_new_password2', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="passwordMatch" class="mt-2"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'accounts:profile' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Annulla
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Cambia Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- SUGGERIMENTI SICUREZZA -->
            <div class="card mt-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt"></i> Consigli per la Sicurezza
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Non usare password gi√† utilizzate in altri siti</li>
                        <li>Non condividere la password con nessuno</li>
                        <li>Cambia la password regolarmente (ogni 3-6 mesi)</li>
                        <li>Usa una password unica e complessa</li>
                        <li>Non scrivere la password su carta o file non protetti</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle password visibility
function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Password strength checker
document.getElementById('id_new_password1').addEventListener('input', function() {
    const password = this.value;
    const strengthDiv = document.getElementById('passwordStrength');
    
    let strength = 0;
    let feedback = [];
    
    // Lunghezza
    if (password.length >= 10) {
        strength += 20;
    } else {
        feedback.push('Almeno 10 caratteri');
    }
    
    // Maiuscole
    if (/[A-Z]/.test(password)) {
        strength += 20;
    } else {
        feedback.push('Almeno una maiuscola');
    }
    
    // Minuscole
    if (/[a-z]/.test(password)) {
        strength += 20;
    } else {
        feedback.push('Almeno una minuscola');
    }
    
    // Numeri
    if (/[0-9]/.test(password)) {
        strength += 20;
    } else {
        feedback.push('Almeno un numero');
    }
    
    // Caratteri speciali
    if (/[^A-Za-z0-9]/.test(password)) {
        strength += 20;
    } else {
        feedback.push('Almeno un carattere speciale');
    }
    
    // Mostra indicatore
    let color = 'danger';
    let text = 'Debole';
    
    if (strength >= 80) {
        color = 'success';
        text = 'Forte';
    } else if (strength >= 60) {
        color = 'warning';
        text = 'Media';
    }
    
    strengthDiv.innerHTML = `
        <div class="progress" style="height: 10px;">
            <div class="progress-bar bg-${color}" 
                 role="progressbar" 
                 style="width: ${strength}%" 
                 aria-valuenow="${strength}" 
                 aria-valuemin="0" 
                 aria-valuemax="100"></div>
        </div>
        <small class="text-${color}"><strong>Forza password: ${text}</strong></small>
        ${feedback.length > 0 ? `<br><small class="text-muted">Manca: ${feedback.join(', ')}</small>` : ''}
    `;
});

// Password match checker
document.getElementById('id_new_password2').addEventListener('input', function() {
    const password1 = document.getElementById('id_new_password1').value;
    const password2 = this.value;
    const matchDiv = document.getElementById('passwordMatch');
    
    if (password2.length === 0) {
        matchDiv.innerHTML = '';
        return;
    }
    
    if (password1 === password2) {
        matchDiv.innerHTML = '<small class="text-success"><i class="fas fa-check"></i> Le password corrispondono</small>';
    } else {
        matchDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times"></i> Le password non corrispondono</small>';
    }
});

// Form validation
(function() {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            const password1 = document.getElementById('id_new_password1').value;
            const password2 = document.getElementById('id_new_password2').value;
            
            if (password1 !== password2) {
                event.preventDefault();
                event.stopPropagation();
                alert('Le password non corrispondono!');
                return false;
            }
            
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
{% endblock %}
