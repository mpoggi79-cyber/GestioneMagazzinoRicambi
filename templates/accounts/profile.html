{% extends 'base.html' %}
{% load static %}

{% block title %}Profilo Utente - Gestione Magazzino Ricambi{% endblock %}

{% block content %}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-lg-8">
            <h1 class="page-title">
                <i class="fas fa-user-circle"></i> Profilo Utente
            </h1>
        </div>
        <div class="col-lg-4 text-end">
            <a href="{% url 'accounts:edit_profile' %}" class="btn btn-primary btn-sm">
                <i class="fas fa-edit"></i> Modifica Profilo
            </a>
        </div>
    </div>

    <!-- DATI PERSONALI -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-id-card"></i> Dati Personali
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Nome Utente</label>
                    <p class="h6">{{ user.username }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Email</label>
                    <p class="h6">{{ user.email|default:"Non impostata" }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Nome</label>
                    <p class="h6">{{ user.first_name|default:"Non impostato" }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Cognome</label>
                    <p class="h6">{{ user.last_name|default:"Non impostato" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- INFORMAZIONI RUOLO -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-shield-alt"></i> Informazioni Ruolo
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Ruolo</label>
                    <p>
                        {% if profilo.ruolo == 'ADMIN' %}
                        <span class="badge bg-danger">{{ profilo.get_ruolo_display }}</span>
                        {% elif profilo.ruolo == 'GESTORE_MAGAZZINO' %}
                        <span class="badge bg-warning">{{ profilo.get_ruolo_display }}</span>
                        {% elif profilo.ruolo == 'OPERATORE' %}
                        <span class="badge bg-info">{{ profilo.get_ruolo_display }}</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ profilo.get_ruolo_display }}</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Stato</label>
                    <p>
                        {% if profilo.attivo %}
                        <span class="badge bg-success">Attivo</span>
                        {% else %}
                        <span class="badge bg-danger">Inattivo</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Dipartimento</label>
                    <p class="h6">{{ profilo.dipartimento|default:"Non assegnato" }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Numero Dipendente</label>
                    <p class="h6">{{ profilo.numero_dipendente|default:"Non assegnato" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PERMESSI -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-key"></i> Permessi
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="text-muted small">Può modificare dati</label>
                    <p>
                        {% if profilo.può_modificare_dati %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> Sì
                        </span>
                        {% else %}
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle"></i> No
                        </span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6">
                    <label class="text-muted small">Può visualizzare tutti i movimenti</label>
                    <p>
                        {% if profilo.può_visualizzare_tutti_movimenti %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle"></i> Sì
                        </span>
                        {% else %}
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle"></i> No
                        </span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- DATE IMPORTANTI -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-calendar-alt"></i> Informazioni Temporali
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Data Creazione Profilo</label>
                    <p class="h6">{{ profilo.data_creazione|date:"d/m/Y H:i" }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Ultimo Accesso</label>
                    <p class="h6">
                        {% if profilo.ultimo_accesso %}
                        {{ profilo.ultimo_accesso|date:"d/m/Y H:i" }}
                        {% else %}
                        Nessun accesso registrato
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Ultima Modifica Profilo</label>
                    <p class="h6">{{ profilo.data_modifica|date:"d/m/Y H:i" }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Data Iscrizione</label>
                    <p class="h6">{{ user.date_joined|date:"d/m/Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ULTIMI ACCESSI -->
    {% if ultimi_accessi %}
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-history"></i> Ultimi Accessi (Ultimi 5)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Data e Ora</th>
                            <th>Indirizzo IP</th>
                            <th>Browser</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for accesso in ultimi_accessi %}
                        <tr>
                            <td>{{ accesso.data_accesso|date:"d/m/Y H:i:s" }}</td>
                            <td>
                                <code class="text-primary">{{ accesso.ip_address|default:"Sconosciuto" }}</code>
                            </td>
                            <td class="text-muted small">
                                {{ accesso.user_agent|truncatewords:5|default:"Sconosciuto" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- AZIONI -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-cog"></i> Azioni
        </div>
        <div class="card-body">
            <a href="{% url 'accounts:edit_profile' %}" class="btn btn-primary btn-sm">
                <i class="fas fa-edit"></i> Modifica Profilo
            </a>
            <a href="{% url 'magazzino:dashboard' %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-home"></i> Torna alla Home
            </a>
        </div>
    </div>
</div>

{% endblock %}
