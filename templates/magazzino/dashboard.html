{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Gestione Magazzino Ricambi{% endblock %}

{% block content %}

<h1 class="page-title">
    <i class="fas fa-chart-line"></i> Dashboard
</h1>

<!-- GRID STATISTICHE -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-top-color: #3498db;">
            <div class="card-body">
                <i class="fas fa-cube" style="font-size: 2.5rem; color: #3498db;"></i>
                <h6 class="card-title text-muted mt-3">Articoli Totali</h6>
                <h2 class="text-primary">{{ total_articoli }}</h2>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-top-color: #2ecc71;">
            <div class="card-body">
                <i class="fas fa-truck" style="font-size: 2.5rem; color: #2ecc71;"></i>
                <h6 class="card-title text-muted mt-3">Fornitori Attivi</h6>
                <h2 class="text-success">{{ total_fornitori }}</h2>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-top-color: #f39c12;">
            <div class="card-body">
                <i class="fas fa-folder" style="font-size: 2.5rem; color: #f39c12;"></i>
                <h6 class="card-title text-muted mt-3">Categorie</h6>
                <h2 class="text-warning">{{ total_categorie }}</h2>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center" style="border-top-color: #e74c3c;">
            <div class="card-body">
                <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #e74c3c;"></i>
                <h6 class="card-title text-muted mt-3">Sotto Soglia</h6>
                <h2 class="text-danger">{{ articoli_sotto_soglia }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- GIACENZE STATISTICHE -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie"></i> Statistiche Giacenze
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 border-end">
                        <h6 class="text-muted mb-2">Quantit√† Disponibile</h6>
                        <h3 class="text-primary">
                            {% if giacenze.total_disponibile %}
                                {{ giacenze.total_disponibile }}
                            {% else %}
                                0
                            {% endif %}
                        </h3>
                        <small class="text-success">
                            <i class="fas fa-arrow-up"></i> Articoli in magazzino
                        </small>
                    </div>
                    <div class="col-6">
                        <h6 class="text-muted mb-2">Quantit√† Impegnata</h6>
                        <h3 class="text-warning">
                            {% if giacenze.total_impegnata %}
                                {{ giacenze.total_impegnata }}
                            {% else %}
                                0
                            {% endif %}
                        </h3>
                        <small class="text-info">
                            <i class="fas fa-hourglass-half"></i> In sospeso
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-user-circle"></i> Informazioni Utente
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <strong>Benvenuto, {{ user.get_full_name|default:user.username }}!</strong>
                </p>
                <p class="mb-2">
                    <i class="fas fa-id-badge"></i> <strong>Ruolo:</strong> {{ ruolo_utente }}
                </p>
                <p class="mb-2">
                    <i class="fas fa-envelope"></i> <strong>Email:</strong> {{ user.email }}
                </p>
                <p class="mb-0">
                    <i class="fas fa-clock"></i> <strong>Ultimo accesso:</strong> 
                    {% if user.last_login %}
                        {{ user.last_login|date:"d/m/Y H:i" }}
                    {% else %}
                        Primo accesso
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- TOP OPERATORI (ULTIMI 30 GIORNI) -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-trophy"></i> Top 5 Operatori - Attivit√†</span>
                <div>
                    <button type="button" class="btn btn-sm btn-info me-2" data-bs-toggle="modal" data-bs-target="#legendaModal">
                        <i class="fas fa-info-circle"></i> Leggenda Punti
                    </button>
                    {% if user.profilo.√®_admin or user.profilo.√®_gestore_magazzino %}
                    <form method="post" action="{% url 'magazzino:reset_classifica' %}" 
                          class="d-inline"
                          onsubmit="return confirm('Sei sicuro di voler azzerare la classifica? Verranno eliminate tutte le azioni registrate.')">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" title="Azzera classifica">
                            <i class="fas fa-redo-alt"></i> Azzera
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                {% if top_operatori %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th>Operatore</th>
                                <th style="text-align: center; width: 30%;">Punti Totali</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for op in top_operatori %}
                            <tr>
                                <td>
                                    {% if forloop.counter == 1 %}
                                    <span class="badge bg-warning" style="font-size: 1.2rem;">ü•á</span>
                                    {% elif forloop.counter == 2 %}
                                    <span class="badge bg-secondary" style="font-size: 1.2rem;">ü•à</span>
                                    {% elif forloop.counter == 3 %}
                                    <span class="badge bg-danger" style="font-size: 1.2rem;">ü•â</span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">{{ forloop.counter }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ op.operatore|default:"Anonimo" }}</strong>
                                </td>
                                <td style="text-align: center;">
                                    <span class="badge bg-success" style="font-size: 1.1rem;">{{ op.totale_articoli }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="p-3 text-center text-muted">
                    <i class="fas fa-inbox"></i> Nessun dato disponibile
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-bar"></i> Dettagli Prestazioni
            </div>
            <div class="card-body">
                {% if top_operatori %}
                <div style="height: 250px;">
                    <canvas id="operatoriChart"></canvas>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
                <script>
                    const operatori = {{ top_operatori_json|safe }};
                    const operatoriNames = operatori.map(o => o.operatore || 'Anonimo');
                    const operatoriArticoli = operatori.map(o => o.totale_articoli);
                    
                    const ctx = document.getElementById('operatoriChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: operatoriNames,
                            datasets: [{
                                label: 'Punti Attivit√†',
                                data: operatoriArticoli,
                                backgroundColor: [
                                    'rgba(255, 193, 7, 0.7)',
                                    'rgba(108, 117, 125, 0.7)',
                                    'rgba(220, 53, 69, 0.7)',
                                    'rgba(23, 162, 184, 0.7)',
                                    'rgba(40, 167, 69, 0.7)'
                                ],
                                borderColor: [
                                    'rgb(255, 193, 7)',
                                    'rgb(108, 117, 125)',
                                    'rgb(220, 53, 69)',
                                    'rgb(23, 162, 184)',
                                    'rgb(40, 167, 69)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                </script>
                {% else %}
                <p class="p-3 text-center text-muted">
                    <i class="fas fa-inbox"></i> Nessun dato disponibile
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ULTIMI MOVIMENTI -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-exchange-alt"></i> Ultimi Movimenti
            </div>
            <div class="card-body p-0">
                {% if ultimi_movimenti %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Articolo</th>
                                <th>Tipo Movimento</th>
                                <th>Quantit√†</th>
                                <th>Operatore</th>
                                <th>Fornitore</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for movimento in ultimi_movimenti %}
                            <tr>
                                <td>{{ movimento.data_movimento|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <a href="{% url 'magazzino:articolo_detail' movimento.articolo.id_articolo %}">
                                        <strong>{{ movimento.articolo.codice_interno }}</strong>
                                    </a>
                                    <br>
                                    <small class="text-muted">{{ movimento.articolo.descrizione|truncatewords:5 }}</small>
                                </td>
                                <td>
                                    {% if movimento.tipo_movimento == 'CARICO' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-arrow-up"></i> {{ movimento.get_tipo_movimento_display }}
                                        </span>
                                    {% elif movimento.tipo_movimento == 'SCARICO' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-arrow-down"></i> {{ movimento.get_tipo_movimento_display }}
                                        </span>
                                    {% elif movimento.tipo_movimento == 'RETTIFICA' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-sync"></i> {{ movimento.get_tipo_movimento_display }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-info">
                                            {{ movimento.get_tipo_movimento_display }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ movimento.quantita }}</strong>
                                </td>
                                <td>{{ movimento.operatore }}</td>
                                <td>
                                    {% if movimento.fornitore %}
                                        <a href="{% url 'magazzino:fornitore_detail' movimento.fornitore.id_fornitore %}">
                                            {{ movimento.fornitore.ragione_sociale }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="p-3 text-center text-muted">
                    <i class="fas fa-inbox"></i> Nessun movimento registrato
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MODAL LEGGENDA PUNTI -->
<div class="modal fade" id="legendaModal" tabindex="-1" aria-labelledby="legendaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="legendaModalLabel">
                    <i class="fas fa-trophy"></i> Leggenda Sistema Punti
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-star"></i>
                    <strong>Come Guadagnare Punti:</strong>
                </div>
                
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60%;">Azione</th>
                            <th class="text-center" style="width: 40%;">Punti</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <i class="fas fa-box text-primary"></i>
                                <strong>Carico Merce</strong>
                                <br><small class="text-muted">Registra un movimento in INGRESSO</small>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-success" style="font-size: 1rem;">+1</span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <i class="fas fa-truck text-success"></i>
                                <strong>Nuovo Fornitore</strong>
                                <br><small class="text-muted">Crea un nuovo fornitore nel sistema</small>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-success" style="font-size: 1rem;">+1</span>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <i class="fas fa-cube text-info"></i>
                                <strong>Nuovo Articolo</strong>
                                <br><small class="text-muted">Crea un nuovo pezzo di ricambio</small>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-success" style="font-size: 1rem;">+1</span>
                            </td>
                        </tr>
                        <tr class="table-warning">
                            <td>
                                <i class="fas fa-image text-warning"></i>
                                <strong>Aggiungi Immagine</strong>
                                <br><small class="text-muted">Carica un'immagine a un articolo (nuovo o esistente)</small>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark" style="font-size: 1.1rem;">+2</span>
                                <br><small class="text-success"><i class="fas fa-gift"></i> Bonus!</small>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="alert alert-info mb-0">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Suggerimento:</strong> Aggiungi sempre un'immagine agli articoli per guadagnare +2 punti bonus!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Chiudi
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
