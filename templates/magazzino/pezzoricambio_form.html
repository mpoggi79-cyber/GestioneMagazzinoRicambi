{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.id_articolo %}Modifica{% else %}Aggiungi{% endif %} Articolo - Gestione Magazzino{% endblock %}

{% block content %}

<h1 class="page-title">
    <i class="fas fa-cube"></i> 
    {% if form.instance.id_articolo %}
        Modifica Articolo: {{ form.instance.codice_interno }}
    {% else %}
        Aggiungi Nuovo Articolo
    {% endif %}
</h1>

<form method="post" enctype="multipart/form-data" novalidate id="articolo-form">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    
                    <!-- Errori globali -->
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger alert-dismissible fade show">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Errore!</strong>
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}
                    
                    <!-- CODICI -->
                    <h6 class="mb-2 mt-2 fw-bold text-primary">Codici Identificativi</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.codice_interno.id_for_label }}" class="form-label">
                                {{ form.codice_interno.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.codice_interno }}
                            {% if form.codice_interno.errors %}
                            <div class="invalid-feedback d-block">{{ form.codice_interno.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.codice_fornitore.id_for_label }}" class="form-label">{{ form.codice_fornitore.label }}</label>
                            {{ form.codice_fornitore }}
                        </div>
                    </div>

                    <!-- SEZIONE SCM -->
                    <h6 class="mb-2 mt-3 fw-bold text-primary">Dati SCM</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.codice_scm.id_for_label }}" class="form-label">{{ form.codice_scm.label }}</label>
                            {{ form.codice_scm }}
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.descrizione_scm.id_for_label }}" class="form-label">{{ form.descrizione_scm.label }}</label>
                            {{ form.descrizione_scm }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.modello_macchina_scm.id_for_label }}" class="form-label">{{ form.modello_macchina_scm.label }}</label>
                            {{ form.modello_macchina_scm }}
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.matricola_macchina_scm.id_for_label }}" class="form-label">{{ form.matricola_macchina_scm.label }}</label>
                            {{ form.matricola_macchina_scm }}
                        </div>
                    </div>

                    <!-- DESCRIZIONE -->
                    <h6 class="mb-2 mt-3 fw-bold text-primary">Descrizione</h6>
                    <div class="mb-2">
                        <label for="{{ form.descrizione.id_for_label }}" class="form-label">
                            {{ form.descrizione.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.descrizione }}
                        {% if form.descrizione.errors %}
                        <div class="invalid-feedback d-block">{{ form.descrizione.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- CATEGORIA, FORNITORE E UNITÀ MISURA -->
                    <h6 class="mb-2 mt-3 fw-bold text-primary">Classificazione</h6>
                    
                    <!-- CATEGORIA GERARCHICA (3 livelli) - Opzionale -->
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label for="{{ form.macrocategoria.id_for_label }}" class="form-label">
                                {{ form.macrocategoria.label }}
                            </label>
                            {{ form.macrocategoria }}
                            {% if form.macrocategoria.errors %}
                            <div class="invalid-feedback d-block">{{ form.macrocategoria.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-2">
                            <label for="{{ form.categoria_livello2.id_for_label }}" class="form-label">
                                {{ form.categoria_livello2.label }}
                            </label>
                            {{ form.categoria_livello2 }}
                            {% if form.categoria_livello2.errors %}
                            <div class="invalid-feedback d-block">{{ form.categoria_livello2.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-2">
                            <label for="{{ form.sottocategoria.id_for_label }}" class="form-label">
                                {{ form.sottocategoria.label }}
                            </label>
                            {{ form.sottocategoria }}
                            {% if form.sottocategoria.errors %}
                            <div class="invalid-feedback d-block">{{ form.sottocategoria.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <small class="text-muted mb-2 d-block">
                        <i class="fas fa-info-circle"></i> 
                        La categoria è opzionale. Puoi assegnarla in un secondo momento.
                    </small>
                    
                    <!-- Breadcrumb categoria selezionata -->
                    <div class="alert alert-info py-2 mb-2" id="categoria-breadcrumb" style="display:none; font-size: 0.9rem;">
                        <strong><i class="fas fa-sitemap"></i> Categoria:</strong> 
                        <span id="breadcrumb-text"></span>
                    </div>
                    
                    <!-- Campo categoria nascosto (valorizzato da JS) -->
                    {{ form.categoria }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.fornitore.id_for_label }}" class="form-label">{{ form.fornitore.label }}</label>
                            {{ form.fornitore }}
                            {% if form.fornitore.errors %}
                            <div class="invalid-feedback d-block">{{ form.fornitore.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.unita_misura.id_for_label }}" class="form-label">
                                {{ form.unita_misura.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.unita_misura }}
                            {% if form.unita_misura.errors %}
                            <div class="invalid-feedback d-block">{{ form.unita_misura.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- GIACENZE E PREZZI -->
                    <h6 class="mb-2 mt-3 fw-bold text-primary">Giacenze e Prezzi</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.giacenza_minima.id_for_label }}" class="form-label">{{ form.giacenza_minima.label }}</label>
                            {{ form.giacenza_minima }}
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.giacenza_massima.id_for_label }}" class="form-label">{{ form.giacenza_massima.label }}</label>
                            {{ form.giacenza_massima }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.prezzo_acquisto.id_for_label }}" class="form-label">{{ form.prezzo_acquisto.label }}</label>
                            {{ form.prezzo_acquisto }}
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <label for="{{ form.prezzo_acquisto_scm.id_for_label }}" class="form-label">{{ form.prezzo_acquisto_scm.label }}</label>
                            {{ form.prezzo_acquisto_scm }}
                        </div>
                    </div>

                    <!-- STATO DISPONIBILITÀ E ATTIVO -->
                    <h6 class="mb-2 mt-3 fw-bold text-primary">Stato</h6>
                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label for="{{ form.stato_disponibilita.id_for_label }}" class="form-label">{{ form.stato_disponibilita.label }}</label>
                            {{ form.stato_disponibilita }}
                            {% if form.stato_disponibilita.errors %}
                            <div class="invalid-feedback d-block">{{ form.stato_disponibilita.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-2 d-flex align-items-end">
                            <div class="form-check">
                                {{ form.stato_attivo }}
                                <label class="form-check-label" for="{{ form.stato_attivo.id_for_label }}">
                                    {{ form.stato_attivo.label }}
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- BOTTONI -->
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-save"></i> 
                            {% if form.instance.id_articolo %}Salva Modifiche{% else %}Crea Articolo{% endif %}
                        </button>
                        <a href="{% url 'magazzino:articolo_list' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> Annulla
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- INFO LATERALE E IMMAGINE -->
        <div class="col-lg-4">
        <!-- IMMAGINE ARTICOLO -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white py-2">
                <i class="fas fa-image"></i> Immagine Articolo
            </div>
            <div class="card-body">
                <!-- Anteprima immagine corrente -->
                <div id="image-preview" class="text-center mb-3">
                    {% if form.instance.immagine %}
                        <img src="{{ form.instance.immagine.url }}" alt="Immagine articolo" class="img-fluid rounded" style="max-height: 300px;">
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-danger" id="remove-image">
                                <i class="fas fa-trash"></i> Rimuovi
                            </button>
                        </div>
                    {% else %}
                        <div class="text-muted py-5" id="no-image-placeholder">
                            <i class="fas fa-image fa-3x mb-2"></i>
                            <p>Nessuna immagine</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Upload da File -->
                <div class="mb-3">
                    <label for="{{ form.immagine.id_for_label }}" class="form-label fw-bold">
                        <i class="fas fa-upload"></i> Carica File
                    </label>
                    {{ form.immagine }}
                    {% if form.immagine.errors %}
                    <div class="invalid-feedback d-block">{{ form.immagine.errors.0 }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">Max 5MB - JPG, PNG, WebP</small>
                </div>
                
                <!-- Drag & Drop Zone -->
                <div id="drop-zone" class="border border-2 border-dashed rounded p-3 text-center mb-3" style="cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                    <p class="mb-0 small text-muted">Trascina qui un'immagine<br>oppure clicca per selezionare</p>
                </div>
                
                <!-- Upload da URL -->
                <div class="mb-2">
                    <label for="{{ form.immagine_url.id_for_label }}" class="form-label fw-bold">
                        <i class="fas fa-link"></i> Oppure da URL
                    </label>
                    {{ form.immagine_url }}
                    {% if form.immagine_url.errors %}
                    <div class="invalid-feedback d-block">{{ form.immagine_url.errors.0 }}</div>
                    {% endif %}
                    <small class="text-muted d-block mt-1">Incolla il link e clicca "Scarica da URL"</small>
                    <button type="button" class="btn btn-sm btn-info mt-2" id="download-url-btn">
                        <i class="fas fa-download"></i> Scarica da URL
                    </button>
                </div>
            </div>
        </div>
        
        <!-- INFO -->
        <div class="card">
            <div class="card-header bg-primary text-white py-2">
                <i class="fas fa-info-circle"></i> Informazioni
            </div>
            <div class="card-body py-2">
                <h6 class="mb-2 fw-bold">Campi Obbligatori</h6>
                <ul class="small mb-2">
                    <li>Codice Interno (univoco)</li>
                    <li>Descrizione</li>
                    <li>Unità di Misura</li>
                </ul>
                
                <hr class="my-2">
                
                <h6 class="mb-2 fw-bold">Suggerimenti</h6>
                <ul class="small mb-2" style="font-size: 0.8rem;">
                    <li>Codici univoci e riconoscibili</li>
                    <li>Descrizioni chiare e dettagliate</li>
                    <li>Categoria opzionale (assegnabile dopo)</li>
                    <li><strong>SCM:</strong> Seleziona prima il modello, poi la matricola</li>
                </ul>
                
                <hr class="my-2">
                
                <h6 class="mb-2 fw-bold"><i class="fas fa-trophy text-warning"></i> Punti Classifica</h6>
                <ul class="small mb-0" style="font-size: 0.8rem;">
                    {% if form.instance.id_articolo %}
                        <li><strong>+2 punti</strong> se aggiungi un'immagine</li>
                    {% else %}
                        <li><strong>+1 punto</strong> per creazione articolo</li>
                        <li><strong>+2 punti</strong> se aggiungi un'immagine</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>
</form>

<script>
// CATEGORIE A CASCATA
document.addEventListener('DOMContentLoaded', function() {
    const macroSelect = document.getElementById('{{ form.macrocategoria.id_for_label }}');
    const cat2Select = document.getElementById('{{ form.categoria_livello2.id_for_label }}');
    const cat3Select = document.getElementById('{{ form.sottocategoria.id_for_label }}');
    const categoriaHidden = document.getElementById('{{ form.categoria.id_for_label }}');
    const breadcrumbDiv = document.getElementById('categoria-breadcrumb');
    const breadcrumbText = document.getElementById('breadcrumb-text');
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function updateBreadcrumb() {
        const parts = [];
        
        if (macroSelect.value) {
            parts.push(macroSelect.options[macroSelect.selectedIndex].text);
        }
        if (cat2Select.value) {
            parts.push(cat2Select.options[cat2Select.selectedIndex].text);
        }
        if (cat3Select.value) {
            parts.push(cat3Select.options[cat3Select.selectedIndex].text);
        }
        
        if (parts.length > 0) {
            breadcrumbText.textContent = parts.join(' > ');
            breadcrumbDiv.style.display = 'block';
        } else {
            breadcrumbDiv.style.display = 'none';
        }
    }
    
    function updateCategoriaHidden() {
        // Imposta il campo nascosto categoria con la più specifica selezionata
        let newValue = '';
        if (cat3Select.value && !cat3Select.disabled) {
            newValue = cat3Select.value;
        } else if (cat2Select.value && !cat2Select.disabled) {
            newValue = cat2Select.value;
        } else if (macroSelect.value && !macroSelect.disabled) {
            newValue = macroSelect.value;
        }
        
        categoriaHidden.value = newValue;
        console.log('Categoria nascosta aggiornata:', newValue); // Debug
        updateBreadcrumb();
    }
    
    function loadCategorieLevel2(macroId) {
        if (!macroId) {
            cat2Select.innerHTML = '<option value="">--- Prima seleziona macrocategoria ---</option>';
            cat2Select.disabled = true;
            cat3Select.innerHTML = '<option value="">--- Nessuna (usa categoria sopra) ---</option>';
            cat3Select.disabled = true;
            updateCategoriaHidden();
            return;
        }
        
        fetch(`/api/categorie/${macroId}/figlie/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cat2Select.innerHTML = '<option value="">--- Seleziona categoria ---</option>';
                data.categorie.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id_categoria;
                    option.text = cat.nome_categoria;
                    cat2Select.appendChild(option);
                });
                cat2Select.disabled = false;
                
                // Reset sottocategoria
                cat3Select.innerHTML = '<option value="">--- Prima seleziona categoria ---</option>';
                cat3Select.disabled = true;
                
                updateCategoriaHidden();
            }
        })
        .catch(error => {
            console.error('Errore caricamento categorie:', error);
        });
    }
    
    function loadCategorieLevel3(cat2Id) {
        if (!cat2Id) {
            cat3Select.innerHTML = '<option value="">--- Nessuna (usa categoria sopra) ---</option>';
            cat3Select.disabled = true;
            updateCategoriaHidden();
            return;
        }
        
        fetch(`/api/categorie/${cat2Id}/figlie/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                cat3Select.innerHTML = '<option value="">--- Nessuna (usa categoria sopra) ---</option>';
                data.categorie.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id_categoria;
                    option.text = cat.nome_categoria;
                    cat3Select.appendChild(option);
                });
                cat3Select.disabled = false;
                updateCategoriaHidden();
            }
        })
        .catch(error => {
            console.error('Errore caricamento sottocategorie:', error);
        });
    }
    
    // Event listeners
    macroSelect.addEventListener('change', function() {
        loadCategorieLevel2(this.value);
    });
    
    cat2Select.addEventListener('change', function() {
        loadCategorieLevel3(this.value);
    });
    
    cat3Select.addEventListener('change', updateCategoriaHidden);
    
    // Verifica prima del submit
    const form = document.getElementById('articolo-form');
    form.addEventListener('submit', function(e) {
        console.log('Submit - Categoria nascosta:', categoriaHidden.value);
        console.log('Submit - Macrocategoria:', macroSelect.value);
        console.log('Submit - Cat2:', cat2Select.value);
        console.log('Submit - Cat3:', cat3Select.value);
        
        // IMPORTANTE: Abilita temporaneamente tutti i dropdown per includere i loro valori nel POST
        // I campi disabled non vengono inviati dal browser
        const cat2WasDisabled = cat2Select.disabled;
        const cat3WasDisabled = cat3Select.disabled;
        cat2Select.disabled = false;
        cat3Select.disabled = false;
        
        // Forza aggiornamento prima del submit
        updateCategoriaHidden();
        
        console.log('Submit - Dopo enable - Cat2 disabled:', cat2Select.disabled, 'value:', cat2Select.value);
        console.log('Submit - Dopo enable - Cat3 disabled:', cat3Select.disabled, 'value:', cat3Select.value);
    });
    
    // Inizializzazione: se in modifica con macrocategoria pre-selezionata
    const initialMacro = macroSelect.value;
    if (initialMacro) {
        // Carica categorie livello 2
        loadCategorieLevel2(initialMacro);
        
        // Dopo il caricamento, pre-seleziona categoria livello 2 se presente
        setTimeout(function() {
            const initialCat2 = '{{ form.categoria_livello2.value|default:"" }}';
            
            if (initialCat2) {
                cat2Select.value = initialCat2;
                
                // Carica categorie livello 3
                loadCategorieLevel3(initialCat2);
                
                // Dopo il caricamento, pre-seleziona sottocategoria se presente
                setTimeout(function() {
                    const initialCat3 = '{{ form.sottocategoria.value|default:"" }}';
                    
                    if (initialCat3) {
                        cat3Select.value = initialCat3;
                    }
                    updateCategoriaHidden();
                    updateBreadcrumb();
                }, 200);
            } else {
                updateCategoriaHidden();
                updateBreadcrumb();
            }
        }, 200);
    } else {
        updateBreadcrumb();
    }
});

// MATRICOLE SCM (script esistente)
document.addEventListener('DOMContentLoaded', function() {
    const modelloSelect = document.getElementById('{{ form.modello_macchina_scm.id_for_label }}');
    const matricolaSelect = document.getElementById('{{ form.matricola_macchina_scm.id_for_label }}');
    
    if (modelloSelect && matricolaSelect) {
        // Salva tutte le opzioni delle matricole
        const allMatricole = Array.from(matricolaSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text,
            modelloId: opt.getAttribute('data-modello-id')
        }));
        
        // Funzione per filtrare le matricole
        function filterMatricole() {
            const selectedModelloId = modelloSelect.value;
            
            // Rimuovi tutte le opzioni tranne la prima (vuota)
            matricolaSelect.innerHTML = '<option value="">---------</option>';
            
            if (selectedModelloId) {
                // Aggiungi solo le matricole del modello selezionato
                allMatricole.forEach(matricola => {
                    if (matricola.modelloId === selectedModelloId) {
                        const option = document.createElement('option');
                        option.value = matricola.value;
                        option.text = matricola.text;
                        matricolaSelect.appendChild(option);
                    }
                });
            } else {
                // Se nessun modello è selezionato, mostra tutte
                allMatricole.forEach(matricola => {
                    if (matricola.value) {  // Skip empty option
                        const option = document.createElement('option');
                        option.value = matricola.value;
                        option.text = matricola.text;
                        matricolaSelect.appendChild(option);
                    }
                });
            }
        }
        
        // Event listener per il cambio di modello
        modelloSelect.addEventListener('change', filterMatricole);
    }
});

// GESTIONE UPLOAD IMMAGINI
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('{{ form.immagine.id_for_label }}');
    const imagePreview = document.getElementById('image-preview');
    const noImagePlaceholder = document.getElementById('no-image-placeholder');
    const removeImageBtn = document.getElementById('remove-image');
    
    // Click sulla drop zone apre il file picker
    if (dropZone && fileInput) {
        dropZone.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Evidenzia drop zone al drag over
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '#0d6efd';
            dropZone.style.backgroundColor = '#e7f1ff';
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '';
            dropZone.style.backgroundColor = '';
        });
        
        // Gestione drop
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = '';
            dropZone.style.backgroundColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                
                // Verifica che sia un'immagine
                if (file.type.startsWith('image/')) {
                    // Assegna il file all'input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Mostra anteprima
                    showImagePreview(file);
                } else {
                    alert('Il file deve essere un\'immagine (JPG, PNG, WebP)');
                }
            }
        });
        
        // Anteprima quando si seleziona un file
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                showImagePreview(this.files[0]);
            }
        });
    }
    
    // Funzione per mostrare anteprima
    function showImagePreview(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            imagePreview.innerHTML = `
                <img src="${e.target.result}" alt="Anteprima immagine" class="img-fluid rounded" style="max-height: 300px;">
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-danger" id="remove-image-preview">
                        <i class="fas fa-trash"></i> Rimuovi
                    </button>
                </div>
            `;
            
            // Nascondi placeholder
            if (noImagePlaceholder) {
                noImagePlaceholder.style.display = 'none';
            }
            
            // Aggiungi evento per rimuovere anteprima
            document.getElementById('remove-image-preview').addEventListener('click', function() {
                fileInput.value = '';
                imagePreview.innerHTML = '';
                if (noImagePlaceholder) {
                    noImagePlaceholder.style.display = 'block';
                }
            });
        };
        
        reader.readAsDataURL(file);
    }
    
    // Rimuovi immagine esistente
    if (removeImageBtn) {
        removeImageBtn.addEventListener('click', function() {
            if (confirm('Rimuovere l\'immagine corrente?')) {
                // Aggiungi checkbox per cancellazione (Django ClearableFileInput)
                const clearCheckbox = document.createElement('input');
                clearCheckbox.type = 'checkbox';
                clearCheckbox.name = 'immagine-clear';
                clearCheckbox.checked = true;
                clearCheckbox.style.display = 'none';
                fileInput.parentNode.appendChild(clearCheckbox);
                
                // Nascondi anteprima
                imagePreview.innerHTML = '';
                if (noImagePlaceholder) {
                    noImagePlaceholder.style.display = 'block';
                }
            }
        });
    }
    
    // Download da URL
    const downloadUrlBtn = document.getElementById('download-url-btn');
    const urlInput = document.getElementById('{{ form.immagine_url.id_for_label }}');
    
    if (downloadUrlBtn && urlInput) {
        downloadUrlBtn.addEventListener('click', function() {
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Inserisci un URL valido');
                return;
            }
            
            // Mostra loading
            downloadUrlBtn.disabled = true;
            downloadUrlBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Download in corso...';
            
            // Download immagine tramite fetch
            fetch(url, { mode: 'cors' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Errore nel download: ' + response.statusText);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Verifica che sia un'immagine
                    if (!blob.type.startsWith('image/')) {
                        throw new Error('Il file scaricato non è un\'immagine valida');
                    }
                    
                    // Estrai nome file dall'URL
                    let filename = url.split('/').pop().split('?')[0] || 'immagine_download.jpg';
                    if (!filename.includes('.')) {
                        const ext = blob.type.split('/')[1] || 'jpg';
                        filename += '.' + ext;
                    }
                    
                    // Crea file dall'immagine scaricata
                    const file = new File([blob], filename, { type: blob.type });
                    
                    // Assegna al file input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Mostra anteprima
                    showImagePreview(file);
                    
                    // Reset bottone
                    downloadUrlBtn.disabled = false;
                    downloadUrlBtn.innerHTML = '<i class="fas fa-check"></i> Download completato!';
                    setTimeout(() => {
                        downloadUrlBtn.innerHTML = '<i class="fas fa-download"></i> Scarica da URL';
                    }, 2000);
                })
                .catch(error => {
                    console.error('Errore download:', error);
                    alert('Errore: ' + error.message + '\n\nSe l\'immagine è su un altro sito, potrebbe esserci un problema CORS.\nProva a salvare l\'immagine sul tuo PC e caricarla da file.');
                    
                    downloadUrlBtn.disabled = false;
                    downloadUrlBtn.innerHTML = '<i class="fas fa-download"></i> Scarica da URL';
                });
        });
    }
});
</script>

{% endblock %}
